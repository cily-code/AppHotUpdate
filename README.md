# android app热更新方案探讨
<h3>前言</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;写在前言：刚开始学习android开发的时候，使用的是前辈们分享到网上的公开资源；入门后，急需各种项目源码来学习编程，也是从网上找的项目源码；再后来，需要解决bug，同样是前辈们分享出来的解决方案；再后来，需要解决方案的时候，也是找的各种资源。许许多多的前辈们，在网上分享自己的资源、经验，给予我们这些后来者很大的帮助，在此先感谢广大网友的无私分享。现在，也萌发了在网上分享一下自己的学习经验和资源。琢磨Hybrid也有一段时间了，在这期间有许许多多的帮助，在此对这些朋友，表示感谢。但由于本人技术有限，难免有遗漏错误的地方，欢迎拍砖，谢谢！</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;app更新速度越来越快，功能也越来越多。辛辛苦苦等待后半夜的到来，然后上线app，刚上线完成，duang！出bug了，心情瞬间跌倒了谷底，心情不好还是次要的，bug不好才要命。于是乎，各种找崩溃log，各种找复现，然后再紧急修复上线。来回折腾不说，用户也开骂了，刚升完级，又来了个更新包，这是在逗我玩吗？可怜的流量啊，就这样在一次又一次的升级中，没了！！！然后，没然后了，部分用户在愤怒中，卸载了app，用户就这样失去了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;难道每次只要下载更新app，才能解决这个问题吗？能不能从技术角度出发，看看有没有技术能实现不需要下载安装新版app，就可以实现修复更新呢？经过一番搜索后，发现目前主要有两个方向来解决热更新的问题。一是ClassLoader方案，有AndFix等框架，但这些框架，并不适用于所有的系统和机型（至少暂时还没有解决好兼容问题）；二是插件话，此方案需要考虑的细节极多，暂时我也没有深入研究过；三是Hybrid app开发，此方案大致有两种类型，WebView加载H5页面和RN；四是等待android官方推出解决方案。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Hybrid app开发，一可以解决跨平台开发，减少开发和维护成本；二可以解决部分热更新的问题。但又不是单纯的加载H5页面，而是既要利用H5页面的优点，同时又保留了调用原生代码的功能（js无法调用硬件，但可以通过调用原生api来调用硬件）</p>
<h3>cordova简介（一）</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Hybrid app开发，一种方案是WebView加载H5页面（html + css + js），直接加载的方案，在此不做过多的谈论，其优缺点，做开发的应该都清楚。我这里所指的Hybrid开发，比较狭义，利用WebView加载H5页面，同时又保留调用原生代码的功能。可能有朋友会提出来，android系统提供了相应的接口方法就可以实现了。的确可以实现，但不是今天我们要讨论的内容，如果有兴趣，可以私下沟通交流这个方案。我们要讨论的是以开源框架cordova为基础的Hybrid开发，如果想详细了解cordova，请移步访问其官网，E文开发文档对于开发者来讲，问题应该不大，虽然也有一些中文翻译，但我不推荐这种做法，感觉cordova更新还是挺快的，中文译文很可能跟不上最新。cordova是一个开源的Hybrid开发框架，目前支持的平台有android、iOS、blackberry10、Ubuntu、wp8、windows8.1等平台（官方提供，可能不是最新的数据）。同时，还有许多优秀的框架，比如ionic、sencha touch等，均以cordova为基础、或配合使用。这些优秀的开源框架配合起来使用，可以解决开发中遇到的大部分问题了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;但是，个人认为，android平台机器太多了，性能也参差不齐，所以，采用的框架越少、越简单越好。个人看法，cordova框架只解决了最最基础核心的js与原生代码通信的问题（部分老版本保留了部分功能）和插件管理，而把复杂的业务逻辑，交给插件去处理。cordova + 插件，组成了一个完成的开发框架。个人看法，cordova的最大亮点就在这里，核心代码只解决通信和插件管理，所有的外围扩展，均通过插件来实现，这样既保证了通信的实现，又能按需扩展，避免加载不必要的功能而导致性能下降，这对于解决android平台的性能问题，很有必要的</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;本项目里，不会涉及到cordova基础开发知识。cordova基础开发及插件开发，请自行搜索如何解决，也欢迎与我交流。后续的重点我会放在如何解决热更新的问题上。</p>
<h3>cordova热更新方案的实现（二）</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;新创建的cordova项目，一般会把所需的资源文件放在assets下，WebView每次都是直接加载assets下的资源问题，这也是cli方式创建项目的默认加载方式。这种方式的优点很明显，加载速度快，省流量；但缺点也同样明显，无法及时更新最新的资源文件，如果采用ajax方式去请求数据，可能存在跨越的问题。另一种方式是把所有的资源问题放在服务器上，WebView每次去加载服务器上的资源，这种模式的优点是能及时更新；缺点是每次需要去加载网络资源，加载速度慢，耗费大量的流量，特别是网络环境比较差的时候，更加难以忍受其加载速度，如果使用缓存，可能会出现无法及时更新的问题（可能是我没有处理好，希望有经验的朋友，不吝赐教）。那么，能不能把资源文件既放在手机本地，又能解决掉及时更新最新的资源文件呢？既然assets下不行，那其他位置，比如SD卡呢？根据实际测试结果来看，WebView加载SD卡的资源文件，是没有问题的，那么这种方案应该具备一定的可行性，下面我们先简单的讨论一下这个方案的实现过程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;app发版本的时候，我们可以把初始化的资源文件，放在assets下，当app启动的时候，程序自动把assets下的资源文件，copy到SD卡，然后WebView去加载SD卡里的资源文件。同时，我们还需要做一个更新接口，在启动app的时候，先去访问更新接口，如果有更新的资源文件，就<b>下载新的资源文件到SD卡上，替换掉旧的资源文件</b>，如果没有，就不做处理。这样就解决掉了热更新的问题，当然，这只是一种方案探讨，具体是否具备应用价值，还需要通过实际项目的检验才行。如果哪位朋友已经应用到实际项目里了，欢迎分享交流经验，谢谢！</p>
<h3>cordova热更新方案的问题探讨（三）</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果按照上面的方案来做，实现热更新应该没有问题的，本来我是准备放一个Demo供大家参考的，但由于需要服务器的配合才能看到更新效果，而我的测试Demo没有服务器挂载，只能在局域网下作为测试用例，所以，最终还是没有放出来。但是，按照上面的方案来做，实现起来，没有什么困难的。在本期中，我们将探讨一下这个方案存在的问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;首先，我们需要解决的是cordova网络请求的白名单问题，这个可以通过白名单插件去解决，这里就不详细讨论了；其次，由于资源文件放在手机本地，通过ajax方式去加载网络数据，这个可能存在跨越的问题，但问题也不大，相信大家也能解决得了；然后，由于资源文件放在手机本地，如何去下载最新的资源文件来覆盖和替换本地资源文件呢？官方提供了文件传输插件，应该也是可以解决的，但我没有采用这种方法，我是通过自定义插件，把文件下载、文件覆盖等功能，通过原生代码去实现的，并做成了插件，供js调用；再后，可能会存在资源文件的管理问题，比如各个用户的版本不一致，如何去管理这些资源文件呢？最后，如何保证本地资源文件的安全性呢？暂时只能想到这些问题，欢迎有经验的朋友批评指正，谢谢！</p>
